<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart DXA Reporter</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background-color: #f4f6f8; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* API & Model Section */
        .setup-section { background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #c8e6c9; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; flex-wrap: wrap; }
        .input-group-api { flex: 2; min-width: 250px; }
        .input-group-api label { font-weight: bold; font-size: 0.9em; color: #2e7d32; display: block; margin-bottom: 5px; }
        .input-group-api a { color: #1565c0; text-decoration: none; font-size: 0.9em; margin-left: 5px; }
        .input-group-api a:hover { text-decoration: underline; }

        input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button.detect-btn { flex: 1; min-width: 150px; padding: 10px; background: #2e7d32; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; height: 42px; }
        button.detect-btn:hover { background: #1b5e20; }
        
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; font-weight: bold; background: #fff;}

        /* Upload Section */
        .upload-area { 
            border: 3px dashed #90caf9; padding: 30px; text-align: center; margin-bottom: 20px; background: #fdfdfd; cursor: pointer; border-radius: 8px;
            transition: all 0.3s;
        }
        .upload-area:hover { background: #f0f8ff; border-color: #1976d2; }
        
        /* Status Bar */
        #status-bar { margin: 15px 0; padding: 10px; border-radius: 6px; font-weight: bold; text-align: center; display: none; }
        .status-ok { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-err { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-wait { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        /* Form Grid */
        .form-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .form-card { flex: 1; min-width: 260px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .form-card h3 { margin: 0 0 15px 0; font-size: 1.1em; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 8px; }
        
        .field-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .field-row input { width: 80px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }

        textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; height: 150px; margin-top: 20px; box-sizing: border-box;}
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn-action { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold; cursor: pointer; color: white; }
        .btn-gen { background: #1976d2; }
        .btn-gen:hover { background: #1565c0; }
        .btn-clear { background: #757575; }
        .btn-clear:hover { background: #616161; }
        .btn-copy { background: #388e3c; margin-top: 20px; width: 100%; }

        #preview-img { max-width: 150px; display: none; margin: 10px auto; border: 1px solid #ddd; padding: 2px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#444; margin-bottom:20px;">AI Smart DXA Reporter</h2>
    
    <div class="setup-section">
        <div class="input-row">
            <div class="input-group-api">
                <label>
                    ğŸ”‘ Google API Key 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" title="é»æ“Šå‰å¾€ Google AI Studio">ğŸ‘‰ (å–å¾—å…è²» Key)</a>
                </label>
                <input type="password" id="apiKey" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š API Key" onchange="saveKey()">
            </div>
            <button class="detect-btn" type="button" onclick="listModels()">ğŸ” åµæ¸¬ä¸¦è¼‰å…¥æ¨¡å‹</button>
        </div>
        
        <div id="modelSelectContainer" style="display:none;">
            <select id="modelSelect" onchange="saveModel()"></select>
            <p style="font-size:0.85em; color:#666; margin-top:5px;">
                * ç³»çµ±å·²è‡ªå‹•å¹«æ‚¨é¸å›ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡å‹ã€‚<br>
                * è‹¥é‡åˆ°éŒ¯èª¤ï¼Œå»ºè­°åˆ‡æ›å› <b>Flash</b> ç³»åˆ—æ¨¡å‹ã€‚
            </p>
        </div>
    </div>

    <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <p style="font-size:1.2em; font-weight:bold; color:#555;">Step 2: è²¼ä¸Šåœ–ç‰‡ (Ctrl+V) æˆ–é»æ“Šä¸Šå‚³</p>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">
        <img id="preview-img">
    </div>

    <div id="status-bar"></div>

    <form name="form">
        <div style="background: #fff8e1; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ffecb3;">
            <b>Patient Info:</b> 
            Age: <input name="Age" type="text" style="width:50px;">
            &nbsp; Sex: 
            <label><input name="Sex" type="radio" value="Male"> M</label>
            <label><input name="Sex" type="radio" value="Female"> F</label>
            &nbsp; (Menopause Age: <input name="Menopause" type="text" style="width:40px;">)
        </div>

        <div class="form-grid">
            
            <div class="form-card">
                <h3>Right Hip (Neck)</h3>
                <div class="field-row"><label>BMD</label><input name="RH_BMD" type="text"></div>
                <div class="field-row"><label>T-score</label><input name="RH_T" type="text"></div>
                <div class="field-row"><label>Z-score</label><input name="RH_Z" type="text"></div>
            </div>

            <div class="form-card">
                <h3>Left Hip (Neck)</h3>
                <div class="field-row"><label>BMD</label><input name="LH_BMD" type="text"></div>
                <div class="field-row"><label>T-score</label><input name="LH_T" type="text"></div>
                <div class="field-row"><label>Z-score</label><input name="LH_Z" type="text"></div>
            </div>

            <div class="form-card">
                <h3>Lumbar Spine (L1-L4)</h3>
                <div class="field-row"><label>BMD</label><input name="L_BMD" type="text"></div>
                <div class="field-row"><label>T-score</label><input name="L_T" type="text"></div>
                <div class="field-row"><label>Z-score</label><input name="L_Z" type="text"></div>
            </div>

        </div>
        
        <p style="margin-top:15px;"><b>Other Findings:</b></p>
        <textarea name="Others" rows="2" style="height:50px;" placeholder="Nil"></textarea>

        <div class="btn-group">
            <button type="button" class="btn-action btn-gen" onclick="activeFunction()">â†» æ›´æ–°å ±å‘Šæ–‡å­—</button>
            <button type="button" class="btn-action btn-clear" onclick="clearForm()">ğŸ—‘ï¸ æ¸…é™¤é‡ä¾† (Clear)</button>
        </div>
    </form>

    <button class="btn-action btn-copy" onclick="copyFunction()">ğŸ“‹ è¤‡è£½æœ€çµ‚å ±å‘Š</button>
    <textarea id="Final_Report" placeholder="æœ€çµ‚å ±å‘Šå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
</div>

<script>
const apiKeyInput = document.getElementById('apiKey');
const modelSelect = document.getElementById('modelSelect');
const statusDiv = document.getElementById('status-bar');

if(localStorage.getItem('gemini_api_key_v2')) {
    apiKeyInput.value = localStorage.getItem('gemini_api_key_v2');
}

function saveKey() {
    localStorage.setItem('gemini_api_key_v2', apiKeyInput.value.trim());
}
function saveModel() {
    localStorage.setItem('gemini_selected_model_safe', modelSelect.value);
}

function showStatus(msg, type) {
    statusDiv.innerHTML = msg;
    statusDiv.style.display = 'block';
    statusDiv.className = type === 'error' ? 'status-err' : (type === 'wait' ? 'status-wait' : 'status-ok');
}

function clearForm() {
    document.form.reset();
    document.getElementById('Final_Report').value = "";
    document.getElementById('preview-img').src = "";
    document.getElementById('preview-img').style.display = 'none';
    document.getElementById('fileInput').value = "";
    document.getElementById('status-bar').style.display = 'none';
}

async function listModels() {
    const key = apiKeyInput.value.trim();
    if(!key) return alert("è«‹å…ˆè¼¸å…¥ API Key");

    showStatus("æ­£åœ¨å¾ Google å–å¾—æ¨¡å‹åˆ—è¡¨...", "wait");
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        const data = await response.json();

        if (data.error) throw new Error(data.error.message);
        
        const safeModels = data.models.filter(m => {
            const name = m.name.toLowerCase();
            return name.includes('gemini') && !name.includes('embedding');
        });

        modelSelect.innerHTML = "";
        safeModels.forEach(m => {
            const id = m.name.replace('models/', '');
            const opt = document.createElement('option');
            opt.value = id;
            opt.text = `${m.displayName} (${id})`;
            if(id.includes('flash')) opt.selected = true;
            modelSelect.appendChild(opt);
        });

        const lastModel = localStorage.getItem('gemini_selected_model_safe');
        if(lastModel) {
             let found = false;
             for(let i=0; i<modelSelect.options.length; i++){
                 if(modelSelect.options[i].value === lastModel){
                     modelSelect.selectedIndex = i;
                     found = true;
                     break;
                 }
             }
             if(found) showStatus(`âœ… å·²åˆ‡æ›å›ä¸Šæ¬¡ä½¿ç”¨çš„: ${lastModel}`, "ok");
             else showStatus("âœ… åˆ—è¡¨æ›´æ–°å®Œæˆ", "ok");
        } else {
             showStatus("âœ… æ¨¡å‹åˆ—è¡¨æ›´æ–°å®Œæˆ", "ok");
        }

        document.getElementById('modelSelectContainer').style.display = 'block';
        
    } catch (e) {
        showStatus("è¼‰å…¥å¤±æ•—: " + e.message, "error");
    }
}

document.addEventListener('paste', (e) => {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (let item of items) {
        if (item.kind === 'file' && item.type.includes('image')) {
            handleFile(item.getAsFile());
        }
    }
});

function handleFile(file) {
    if (!file) return;
    const img = document.getElementById('preview-img');
    img.src = URL.createObjectURL(file);
    img.style.display = 'block';

    const reader = new FileReader();
    reader.onloadend = () => {
        const base64String = reader.result.split(',')[1];
        analyzeImage(base64String, file.type);
    };
    reader.readAsDataURL(file);
}

// æ ¸å¿ƒåˆ†æå‡½å¼ (ä¿®æ­£: è¦æ±‚å›å‚³ String ä»¥ä¿ç•™å°æ•¸é»)
async function analyzeImage(base64, mimeType) {
    const key = apiKeyInput.value.trim();
    let modelName = modelSelect.value;
    if(!modelName) modelName = "gemini-1.5-flash"; 

    showStatus(`æ­£åœ¨ä½¿ç”¨ <b>${modelName}</b> åˆ†æä¸­...`, "wait");

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${key}`;
    
    // æ›´æ–° Prompt: è¦æ±‚æ•¸å€¼å›å‚³ç‚º String
    const prompt = `
    Analyze this Bone Mineral Density (DXA) report image. Extract data into JSON.
    
    IMPORTANT: Return all numeric values (BMD, T-score, Z-score) as STRINGS to preserve trailing zeros (e.g. "-1.0" instead of -1).
    
    Fields: 
    - Age (number)
    - Sex (Male/Female)
    - Menopause_Age (number, extract only if "Menopause" or "åœç¶“" age appears)
    - RH_BMD, RH_T, RH_Z (Right Hip) - return as string
    - LH_BMD, LH_T, LH_Z (Left Hip) - return as string
    - L_BMD, L_T, L_Z (Lumbar Spine/L1-L4) - return as string
    
    Return ONLY JSON. Use null for missing values.
    `;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: mimeType, data: base64 } }
                    ]
                }]
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        
        let text = data.candidates[0].content.parts[0].text;
        text = text.replace(/```json|```/g, '').trim();
        const result = JSON.parse(text);

        console.log("AI Result:", result);
        showStatus("âœ… åˆ†ææˆåŠŸï¼", "ok");
        fillForm(result);

    } catch (e) {
        console.error(e);
        showStatus("âŒ éŒ¯èª¤: " + e.message, "error");
    }
}

function fillForm(d) {
    const f = document.form;
    const s = (field, val) => { if(val != null) field.value = val; };

    s(f.Age, d.Age);
    if(d.Sex) {
        if(d.Sex.toLowerCase().includes('fe')) f.Sex[1].checked = true;
        else f.Sex[0].checked = true;
    }
    
    s(f.Menopause, d.Menopause_Age);

    s(f.L_BMD, d.L_BMD); s(f.L_T, d.L_T); s(f.L_Z, d.L_Z);
    s(f.LH_BMD, d.LH_BMD); s(f.LH_T, d.LH_T); s(f.LH_Z, d.LH_Z);
    s(f.RH_BMD, d.RH_BMD); s(f.RH_T, d.RH_T); s(f.RH_Z, d.RH_Z);

    activeFunction();
}

function copyFunction() {
  var copyText = document.getElementById("Final_Report");
  copyText.select();
  navigator.clipboard.writeText(copyText.value);
}   

function activeFunction() {
  var Reference = "T-score";
  var AgeVal = parseFloat(document.form.Age.value) || 0;
  if (document.form.Sex.value == "Male" && AgeVal < 50) Reference = "Z-score";
  if (document.form.Sex.value == "Female" && !document.form.Menopause.value) Reference = "Z-score";

  var SexText = document.form.Sex.value == "Female" ? 
      (document.form.Menopause.value ? "Female with menopause at age of " + document.form.Menopause.value : "Female without menopause") : "Male";

  function interpret(t, z, ref, region) {
      if(!t && !z) return "Not performed.";
      var tVal = parseFloat(t), zVal = parseFloat(z);
      var text = "";
      if (ref === "T-score") {
          if (tVal <= -2.5) text = "Osteoporosis (T-score <= -2.5)";
          else if (tVal < -1.0) text = "Low bone mass (-2.5 < T-score < -1.0)";
          else text = "Within normal limit (T-score >= -1.0)";
      } else {
          text = zVal <= -2.0 ? "below the expected range for age (Z-score <= -2.0)" : "within the expected range for age (Z-score > -2.0)";
      }
      return `BMD: ${document.form[region+'_BMD'].value}g/cm2, T-score: ${t}, Z-score: ${z},\nInterpretation: The BMD of the ${region=='L'?'lumbar spine':(region=='LH'?'left hip':'right hip')} is corresponding to the condition of ${text}`;
  }

  var resL = interpret(document.form.L_T.value, document.form.L_Z.value, Reference, 'L');
  var resLH = interpret(document.form.LH_T.value, document.form.LH_Z.value, Reference, 'LH');
  var resRH = interpret(document.form.RH_T.value, document.form.RH_Z.value, Reference, 'RH');

  var others = document.getElementsByName('Others')[0].value || "Nil";

  document.getElementById('Final_Report').value = 
`# Imaging Report Form for Bone Mineral Density Scan #

1.Patient Information:
Age: ${document.form.Age.value},    Sex: ${SexText}

2.Reference: ${Reference}

3.The bone mineral density (BMD) of the following regions was measured using dual-energy X-ray absorptiometry (DXA).
The BMD values, along with their corresponding standard deviations (SD) for T-scores and Z-scores, are summarized as follows:

Lumbar spine (L1-L4):
${resL}

Left hip:
${resLH}

Right hip:
${resRH}

Other Findings:
${others}`;
}
</script>
</body>
</html>